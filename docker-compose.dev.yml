services:
  iotnet:
    build:
      context: .
      dockerfile: Dockerfile.dev
    working_dir: /app
    ports:
      - "${PORTOFOLIO_PORT}:3000"
      - "${BACKEND_PORT}:8080"
    volumes:
      - ./:/app
      - iotnet_dev_data:/app/.dev_data
    env_file:
      - .env.dev
    environment:
      - SERVER_PORT=${PORTOFOLIO_PORT}
      - BACKEND_PORT=${BACKEND_PORT}
      - DB_HOST=database
      - DB_PORT=5432
      - DB_USER=${POSTGRES_USER}
      - DB_PASSWORD=${POSTGRES_PASSWORD}
      - DB_NAME=${POSTGRES_DB}
    depends_on:
      database:
        condition: service_healthy
      user-management:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 120s

  user-management:
    build:
      context: ./services/Multitenant-User-Management-Service
      dockerfile: Dockerfile.dev
    ports:
      - "${AUTH_PORT}:5500"
    volumes:
      - ./services/Multitenant-User-Management-Service:/app
      - user_management_dev_data:/app/.dev_data
    env_file:
      - .env.dev
    environment:
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@database:5432/${CORE_DB_NAME:-iotnet_auth}
      - CORE_DB_TYPE=postgres
      - CORE_DB_HOST=database
      - CORE_DB_PORT=5432
      - CORE_DB_USER=${POSTGRES_USER}
      - CORE_DB_PASS=${POSTGRES_PASSWORD}
      - CORE_DB_NAME=${CORE_DB_NAME:-iotnet_auth}
      - SERVER_PORT=5500
      - ENDPOINT=${ENDPOINT:-http://localhost:5500}
      - VITE_ALLOWED_ORIGINS=${VITE_ALLOWED_ORIGINS}
      - GRACE_PERIOD_SECS=${GRACE_PERIOD_SECS:-5}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5500/health"]
      interval: 15s
      timeout: 10s
      retries: 60
      start_period: 300s

  database:
    image: postgres:16-alpine
    container_name: iotnet-db-dev
    env_file:
      - .env.dev
    ports:
      - "${POSTGRES_PORT}:5432"
    volumes:
      - postgres_dev_data:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/init-db.sh
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres_dev_data:
  iotnet_dev_data:
  user_management_dev_data:
